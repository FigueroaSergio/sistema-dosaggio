<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema di Dosaggio Intelligente</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for the weight display */
      .weight-main-display {
        font-family: "Inter", sans-serif;
        font-size: 4rem;
        font-weight: 800;
      }
      /* Style for the table row currently being worked on */
      .current-ingredient-row {
        background-color: #f0fdf4 !important; /* Green 50 */
        border-left: 5px solid #059669; /* Green 600 */
      }
      /* Style for completed row */
      .completed-ingredient-row {
        background-color: #f0f9ff; /* Sky 50 */
      }
      /* Smooth transitions for better visual feedback */
      progress {
        transition: width 0.3s ease-in-out;
        height: 10px;
        border-radius: 5px;
        overflow: hidden;
        background-color: #e5e7eb; /* Gray 200 */
      }
      /* Make the main progress bar taller for better visibility */
      #main-progress-bar {
        height: 18px; /* increased height */
        border-radius: 8px;
      }
      /* Base styles for progress bar track */
      progress::-webkit-progress-bar {
        background-color: #e5e7eb;
      }
      /* Progress value color defined by JS */
      progress::-webkit-progress-value {
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      progress::-moz-progress-bar {
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      /* Color classes for dynamic styling */
      .progress-color-black {
        color: #1f2937;
      } /* Gray 800 */
      .progress-color-blue {
        color: #3b82f6;
      } /* Blue 500 */
      .progress-color-green {
        color: #10b981;
      } /* Emerald 500 */
      .progress-color-yellow {
        color: #f59e0b;
      } /* Amber 500 */
      .progress-color-orange {
        color: #f97316;
      } /* Orange 600 */
      .progress-color-red {
        color: #ef4444;
      } /* Red 500 */

      /* Utility for setting bar color via CSS variables */
      .bar-color-blue::-webkit-progress-value {
        background-color: #3b82f6;
      }
      .bar-color-green::-webkit-progress-value {
        background-color: #10b981;
      }
      .bar-color-yellow::-webkit-progress-value {
        background-color: #f59e0b;
      }
      .bar-color-orange::-webkit-progress-value {
        background-color: #f97316;
      }
      .bar-color-red::-webkit-progress-value {
        background-color: #ef4444;
      }
      .bar-color-black::-webkit-progress-value {
        background-color: #1f2937;
      }

      .bar-color-blue::-moz-progress-bar {
        background-color: #3b82f6;
      }
      .bar-color-green::-moz-progress-bar {
        background-color: #10b981;
      }
      .bar-color-yellow::-moz-progress-bar {
        background-color: #f59e0b;
      }
      .bar-color-orange::-moz-progress-bar {
        background-color: #f97316;
      }
      .bar-color-red::-moz-progress-bar {
        background-color: #ef4444;
      }
      .bar-color-black::-moz-progress-bar {
        background-color: #1f2937;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900">
          Sistema di Dosaggio Intelligente
        </h1>
        <p class="text-gray-500">
          Guida passo-passo per le tue ricette.
          <span class="font-bold">Inserimento peso in Kg.</span>
        </p>
      </header>

      <!-- SECCI√ìN 1: CONTROL Y ESTADO PRINCIPAL -->
      <div
        id="main-status-card"
        class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-teal-200"
      >
        <h2 class="text-lg font-semibold text-gray-700 mb-3">
          Peso Netto Aggiunto
        </h2>

        <!-- DISPLAY PRINCIPAL -->
        <div class="flex flex-col items-center justify-center py-4">
          <!-- Main Weight Display -->
          <div class="flex items-end">
            <span
              id="added-weight-display"
              class="weight-main-display text-gray-800 transition-colors duration-300"
              >0.00</span
            >
            <span class="text-3xl text-gray-500 ml-2 mb-2">g</span>
          </div>

          <!-- Small Instruction/Target Text -->
          <p
            id="target-weight-display"
            class="text-center text-sm text-gray-400 font-semibold mt-[-10px]"
          >
            Peso netto (Peso lordo - Tara precedente)
          </p>

          <!-- Current Ingredient Progress Bar -->
          <div
            id="main-progress-bar-container"
            class="w-full mt-4"
            style="display: none"
          >
            <progress
              id="main-progress-bar"
              value="0"
              max="100"
              class="w-full bar-color-black"
            ></progress>
            <p
              id="main-progress-percent"
              class="text-sm font-medium text-gray-500 text-center mt-1 progress-color-black"
            >
              0% Versato
            </p>
          </div>
        </div>

        <!-- INSTRUCCI√ìN ACTUAL -->
        <div class="bg-teal-50 border-l-4 border-teal-500 p-4 mt-4 rounded-md">
          <p id="current-instruction" class="text-teal-800 font-medium">
            üëã Seleziona una ricetta per iniziare la preparazione.
          </p>
        </div>

        <!-- ACCIONES DE PREPARACI√ìN -->
        <div id="prep-actions" class="flex gap-4 mt-6 justify-center">
          <button
            id="zero-btn"
            class="px-6 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition duration-150 w-full max-w-xs sm:max-w-[150px]"
          >
            Azzerare
          </button>
          <button
            id="next-ingredient-btn"
            class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 w-full max-w-xs sm:max-w-[200px]"
            style="display: none"
          >
            Ingrediente Successivo
          </button>
          <button
            id="recalc-btn"
            class="px-6 py-3 bg-amber-500 text-white font-bold rounded-lg shadow-md hover:bg-amber-600 transition duration-150 w-full max-w-xs sm:max-w-[200px]"
            style="display: none"
            title="Ricalcola le quantit√† degli ingredienti rimanenti per assorbire l'eccesso"
          >
            Ricalcola Quantit√†
          </button>
        </div>
      </div>

      <!-- SECCI√ìN 2: SELECCI√ìN DE RECETAS Y PESOS DE REFERENCIA -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- CARD 1: SELECCI√ìN -->
        <div class="lg:col-span-1 bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Ricetta</h3>
          <select
            id="recipe-selector"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150"
          >
            <option value="">-- Seleziona una ricetta --</option>
          </select>
          <button
            id="start-prep-btn"
            class="w-full mt-4 p-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150"
          >
            Inizia
          </button>
        </div>

        <!-- CARD 2 & 3: ESTADO DE PESOS DE REFERENCIA -->
        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-gray-100 p-4 rounded-lg sm:col-span-2">
            <p class="text-sm font-medium text-gray-500">Peso Lordo (Kg)</p>
            <span id="raw-weight" class="text-4xl font-extrabold text-gray-800"
              >0.00 g</span
            >
          </div>
          <div class="bg-gray-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-gray-500">Tara (Contenitore)</p>
            <span id="tare-weight" class="text-2xl font-bold text-gray-800"
              >0.00g</span
            >
          </div>
        </div>
      </div>

      <!-- SECCI√ìN 3: TABLA DE RECETA Y PROGRESO -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h2 id="prep-title" class="text-2xl font-bold text-gray-800 mb-4">
          Dettaglio della Ricetta
        </h2>

        <div class="overflow-x-auto">
          <table id="recipe-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  scope="col"
                  class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Ingrediente
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Richiesto (g)
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Peso Aggiunto (g)
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4"
                >
                  Progresso
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  % Versato
                </th>
              </tr>
            </thead>
            <tbody
              id="recipe-table-body"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Filas de ingredientes se insertar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="./ricette-full.js"></script>

    <script type="text/javascript">
      // =================================================================
      // 1. CLASE WEIGHTPUBLISHER (Publicador - Fuente de datos de la b√°scula)
      // =================================================================
      let ricette = ricette_tutte;

      class WeightPublisher {
        constructor() {
          this.weightKg = 0; // Peso bruto en Kilogramos (entrada simulada)
          this.weightGrams = 0; // Peso bruto en Gramos (usado internamente)
          this.subscribers = [];
        }

        subscribe(subscriber) {
          if (typeof subscriber.update === "function") {
            this.subscribers.push(subscriber);
          }
        }

        // Establece el peso bruto le√≠do de la b√°scula (asume entrada en Kg)
        setWeight(newWeightKgString) {
          // Entrada: "X,XX" (en Kg). Reemplazamos la coma por punto para JS.
          const numericWeightKg = parseFloat(
            newWeightKgString.replace(",", ".")
          );
          console.log(newWeightKgString);

          if (!isNaN(numericWeightKg)) {
            // Convertir Kg a Gramos para la l√≥gica interna
            const newWeightGrams = numericWeightKg * 1000;

            // Solo actualiza y notifica si el peso ha cambiado significativamente
            if (Math.abs(this.weightGrams - newWeightGrams) > 0.001) {
              if (this.weightGrams == newWeightGrams) return;
              this.weightKg = numericWeightKg;
              this.weightGrams = newWeightGrams;

              this.notify(this.weightGrams);
            }
          }
        }

        notify(weightGrams) {
          this.subscribers.forEach((subscriber) => {
            subscriber.update(weightGrams, this.weightKg);
          });
        }
      }
      class Recipe {
        constructor(name, ingredients) {
          this.name = name;
          this.ingredients = ingredients;
        }
        getIngredients() {
          return this.ingredients;
        }
      }
      // =================================================================
      // 2. CLASE RECIPEMANAGER (Gestor de Recetas - Datos de la aplicaci√≥n)
      // =================================================================

      class RecipeManager {
        constructor() {
          // Estructura de recetas (todo en gramos)
          this.recipes = ricette;
        }

        getRecipe(name) {
          return this.recipes[name];
        }

        getRecipeNames() {
          return Object.keys(this.recipes);
        }
      }

      // =================================================================
      // 3. CLASE RECIPEPREPCONTROLLER (Controlador - L√≥gica de Preparaci√≥n)
      // =================================================================

      class RecipePrepController {
        constructor(recipeManager) {
          this.recipeManager = recipeManager;
          this.recipe = null;
          this.currentIngredientIndex = -2; // -2: INACTIVO, -1: TARA, 0+: Ingredientes
          this.tareWeight = 0; // Peso del contenedor
          this.accumulatedWeight = 0; // Peso de los ingredientes ya guardados (incluye tara)
          this.currentWeightGrams = 0; // Peso bruto le√≠do de la b√°scula (en gramos)
          this.displayManager = new PrepDisplayManager(); // Maneja la actualizaci√≥n del DOM
        }

        // M√©todo requerido por el WeightPublisher (Observer)
        update(rawWeightGrams) {
          console.log("update");

          this.currentWeightGrams = rawWeightGrams;

          // Actualiza siempre los pesos de referencia
          this.displayManager.updateStatus(
            rawWeightGrams,
            this.tareWeight,
            this.accumulatedWeight
          );

          if (this.currentIngredientIndex === -1) {
            // Modo TARA: el display principal solo muestra el peso bruto
            this.displayManager.updateMainWeightDisplay(
              this.currentWeightGrams,
              "Pesare Contenitore",
              null,
              0
            );
            this.displayManager.setZeroButtonEnabled(true);
          } else if (this.currentIngredientIndex >= 0) {
            // Modo Ingrediente

            this.updateIngredientProgress();
            this.displayManager.setZeroButtonEnabled(false);
          } else {
            // Modo Inactivo/Finalizado: muestra el peso bruto
            this.displayManager.updateMainWeightDisplay(
              this.currentWeightGrams,
              null,
              null,
              0
            );
            this.displayManager.setZeroButtonEnabled(true);
          }
        }

        startPreparation(recipeName) {
          // Clone recipe for this session so we can modify quantities without mutating the base data.
          // Also store originalGrams for each ingredient to keep a reference.
          const baseRecipe = this.recipeManager.getRecipe(recipeName);
          if (!baseRecipe) return;
          this.recipe = baseRecipe.map((it) => ({
            ...it,
            originalGrams: it.grams,
          }));

          this.currentIngredientIndex = -1; // Inicia en modo TARA
          this.tareWeight = 0;
          this.accumulatedWeight = 0;
          this.weightIngredients = new Array(this.recipe.length).fill(0);

          this.displayManager.renderRecipe(this.recipe, recipeName);
          this.displayManager.setNextButtonVisibility(true); // Mostrar bot√≥n Siguiente
          this.displayManager.setNextButtonText(false, true); // Mostrare "Tarare" nel primo passo (TARA)
          this.displayManager.showInstructions(
            "Passo 1: Metti il contenitore vuoto sulla bilancia e premi <strong>SUCCESSIVO</strong> per impostare la tara."
          );

          // **CORRECCI√ìN:** Habilitar el bot√≥n Poner a Cero inmediatamente al entrar en modo TARA.
          this.displayManager.setZeroButtonEnabled(true);

          // Forzar la actualizaci√≥n del display principal a 0.00g (antes de recibir el primer peso de la b√°scula)
          this.displayManager.updateMainWeightDisplay(
            0.0,
            "Pesare Contenitore",
            null,
            0
          );
        }
        saveWeight() {
          console.log("Saving weight: ", this.currentWeightGrams);
          let currentIngredientIndex = this.currentIngredientIndex;
          if (currentIngredientIndex == -1) {
            this.tareWeight = this.currentWeightGrams;
          } else {
            this.weightIngredients[currentIngredientIndex] =
              this.currentWeightGrams -
              (this.getAccumulatedWeight() - this.getPreviusWeight());
          }
          console.log("New state: ", this);
        }
        getAccumulatedWeight() {
          return (
            this.tareWeight +
            this.weightIngredients.reduce((prev, curr) => prev + curr, 0)
          );
        }
        getPreviusWeight() {
          let step = this.currentIngredientIndex;
          if (step == -1) {
            return this.tareWeight;
          }
          return this.weightIngredients[step];
        }
        /**
         * Avanza al siguiente paso (Tara, Ingrediente N, Finalizar).
         * En cada avance, acumula el peso actual.
         */
        nextStep() {
          if (!this.recipe) return;
          this.setStep(this.currentIngredientIndex + 1);
        }

        setStep(step) {
          this.saveWeight();
          this.currentIngredientIndex = step;
          // 1. L√ìGICA DE ACUMULACI√ìN (Tarar impl√≠citamente)

          // Si venimos del paso TARA (-1), establecemos el tareWeight inicial para referencia.
          if (this.currentIngredientIndex === -1) {
            this.tareWeight = this.currentWeightGrams;
          }

          // 2. AVANCE DE √çNDICE Y ACCIONES DE UI

          // Si estamos en un ingrediente, marcamos la fila como completada.
          if (this.currentIngredientIndex >= 0) {
            this.displayManager.markRowAsCompleted(this.currentIngredientIndex);
          }

          // Avanzar al siguiente paso (0, 1, 2, ...)

          // 3. VERIFICACI√ìN DE FIN DE RECETA
          if (this.currentIngredientIndex >= this.recipe.length) {
            this.currentIngredientIndex = -2; // Marca como completado/inactivo
            const netTotal = this.accumulatedWeight - this.tareWeight;
            this.displayManager.showInstructions(
              `‚úÖ Ricetta completata! Peso netto totale: <strong>${netTotal.toFixed(
                2
              )}</strong>g.`
            );
            this.displayManager.updateCurrentIngredient(null);
            this.displayManager.resetUI(); // Reset UI
            return;
          }

          // 4. PREPARAR EL SIGUIENTE INGREDIENTE

          const ingredient = this.recipe[this.currentIngredientIndex];

          // Actualizar texto del bot√≥n a "Finalizar" si es el √∫ltimo
          const isFinal =
            this.currentIngredientIndex === this.recipe.length - 1;
          const isTare = this.currentIngredientIndex === -1;
          this.displayManager.setNextButtonText(isFinal, isTare);

          // Gu√≠a al siguiente ingrediente
          this.displayManager.showInstructions(
            `Passo ${this.currentIngredientIndex + 2}: Aggiungere <strong>${
              ingredient.name
            }</strong> (richiesti: ${ingredient.grams}g).`
          );
          this.displayManager.updateCurrentIngredient(
            this.currentIngredientIndex
          );

          // FIX: Forzar una actualizaci√≥n de la UI inmediatamente despu√©s de tarar/cambiar de ingrediente.
          // Usamos el peso actual en Kg (0.00kg si no ha llegado una lectura real) para la actualizaci√≥n.
          console.log("Pre-update");

          this.update(this.currentWeightGrams, scalePublisher.weightKg);
        }

        // Actualiza el progreso del ingrediente actual
        updateIngredientProgress() {
          const ingredient = this.recipe[this.currentIngredientIndex];
          if (!ingredient) return;
          console.log(this);
          console.log("Currente total: ", this.getAccumulatedWeight());

          // Peso Neto A√±adido = Peso Bruto (B√°scula) - Peso Acumulado de todo lo anterior
          const addedGrams =
            this.currentWeightGrams -
            (this.getAccumulatedWeight() - this.getPreviusWeight());

          // NO CLAMPING: Permitimos que addedGrams sea negativo (si se quita peso) o positivo (si se a√±ade)
          const requiredGrams = ingredient.grams;

          // Calculamos el porcentaje, permitiendo valores > 100
          const percentage = (addedGrams / requiredGrams) * 100;

          // Actualizar Display Principal (peso, nombre, requerido y progreso)
          this.displayManager.updateMainWeightDisplay(
            addedGrams, // Puede ser negativo
            ingredient.name,
            requiredGrams,
            percentage
          );

          // Actualizar Tabla
          this.displayManager.updateTableProgress(
            this.currentIngredientIndex,
            addedGrams,
            requiredGrams,
            percentage
          );

          // Mostrar/ocultar el bot√≥n de recalcular si hay overflow (>100%).
          // Ahora tambi√©n se mostrar√° en el √∫ltimo ingrediente para permitir recalcular/escalar la receta completa.
          const hasOverflow = percentage > 100;
          this.displayManager.setRecalcButtonVisibility(hasOverflow);
        }

        // Nueva funci√≥n que recalcula manteniendo proporciones originales entre los ingredientes restantes
        recalculateKeepProportions() {
          if (!this.recipe) return;
          const idx = this.currentIngredientIndex;
          if (idx < 0 || idx >= this.recipe.length) return;

          const ingredient = this.recipe[idx];
          const addedGrams =
            this.currentWeightGrams -
            (this.getAccumulatedWeight() - this.getPreviusWeight());
          let overflow = addedGrams - ingredient.grams;

          if (overflow <= 0) {
            this.displayManager.showInstructions("No hay exceso para ajustar.");
            this.displayManager.setRecalcButtonVisibility(false);
            return;
          }

          // Nueva estrategia: escalar la receta completa para mantener proporciones originales de TODOS los ingredientes
          // s = factor de escala tal que originalGrams[current] * s >= addedGrams
          // Adem√°s nos aseguramos que para cualquier ingrediente previo (ya a√±adido), newReq >= already

          const origAll = this.recipe.map((it) => it.originalGrams || it.grams);
          const alreadyAll = this.recipe.map((_, i) =>
            this.weightIngredients && this.weightIngredients[i]
              ? this.weightIngredients[i]
              : 0
          );

          const origCurrent = origAll[idx] || 0;
          if (origCurrent <= 0) {
            this.displayManager.showInstructions(
              "Impossibile ricalcolare: l'ingrediente corrente non ha quantit√† originali definite."
            );
            this.displayManager.setRecalcButtonVisibility(false);
            return;
          }

          const sCandidate = addedGrams / origCurrent; // factor para que el ingrediente actual quede 'encajado' en la receta escalada
          // s must also satisfy that for all previous ingredients, newReq >= already
          let sMinPrev = 0;
          for (let j = 0; j <= idx; j++) {
            const origJ = origAll[j] || 0;
            const alreadyJ = alreadyAll[j] || 0;
            if (origJ > 0) {
              sMinPrev = Math.max(sMinPrev, alreadyJ / origJ);
            }
          }

          // Factor final: al menos el que ajusta el actual y suficiente para que previos no queden por encima de la nueva meta
          const s = Math.max(sCandidate, sMinPrev);

          // Aplicar nueva receta escalada (redondeo a 2 decimales)
          for (let j = 0; j < this.recipe.length; j++) {
            const newReq = +(origAll[j] * s).toFixed(2);
            // Aseguramos no poner el requerimiento menor que lo ya agregado (protecci√≥n extra)
            const finalReq =
              newReq < (alreadyAll[j] || 0)
                ? +(alreadyAll[j] || 0).toFixed(2)
                : newReq;
            this.recipe[j].grams = finalReq;
            this.displayManager.updateIngredientRequiredGram(j, finalReq);
          }

          // Ajustar porcentajes/barras seg√∫n weightIngredients y la lectura actual del ingrediente actual
          for (let j = 0; j < this.recipe.length; j++) {
            const req = this.recipe[j].grams;
            const added =
              j === idx
                ? addedGrams
                : this.weightIngredients && this.weightIngredients[j]
                ? this.weightIngredients[j]
                : 0;
            const percent = req > 0 ? (added / req) * 100 : 100;
            this.displayManager.updateTableProgress(j, added, req, percent);
          }

          // Actualizar el display principal con el ingrediente actual recalculado
          const reqCurrent = this.recipe[idx].grams;
          const percentCurrent =
            reqCurrent > 0 ? (addedGrams / reqCurrent) * 100 : 100;
          this.displayManager.updateMainWeightDisplay(
            addedGrams,
            ingredient.name,
            reqCurrent,
            percentCurrent
          );

          this.displayManager.showInstructions(
            `√à stata generata una ricetta scalata che mantiene le proporzioni originali (fattore: ${s.toFixed(
              3
            )}).`
          );

          this.displayManager.setRecalcButtonVisibility(false);
        }
      }

      // =================================================================
      // 4. CLASE PREPDISPLAYMANAGER (Manejo del DOM y UI)
      // =================================================================

      class PrepDisplayManager {
        // Funci√≥n auxiliar para obtener la clase de color basada en el porcentaje
        getProgressBarColorClass(percentage) {
          let colorClass;
          if (percentage < 0) {
            colorClass = "bar-color-black";
          } else if (percentage < 50) {
            colorClass = "bar-color-black"; // 0-50% -> Negro
          } else if (percentage < 95) {
            colorClass = "bar-color-blue"; // 50-95% -> Azul
          } else if (percentage <= 101) {
            colorClass = "bar-color-green"; // 95-101% -> Verde (Zona √≥ptima)
          } else if (percentage < 110) {
            colorClass = "bar-color-yellow"; // 101-110% -> Amarillo
          } else if (percentage < 125) {
            colorClass = "bar-color-orange"; // 110-125% -> Naranja
          } else {
            // 125% o m√°s
            colorClass = "bar-color-red"; // 125+ -> Rojo
          }
          return colorClass;
        }

        getWeightTextColorClass(percentage) {
          const baseClass =
            "weight-main-display transition-colors duration-300";
          let colorClass;
          if (percentage < 0) {
            colorClass = "text-gray-500";
          } else if (percentage < 50) {
            colorClass = "text-gray-800"; // 0-50% -> Negro
          } else if (percentage < 95) {
            colorClass = "text-blue-600"; // 50-95% -> Azul
          } else if (percentage <= 101) {
            colorClass = "text-green-600"; // 95-101% -> Verde
          } else if (percentage < 110) {
            colorClass = "text-amber-500"; // 101-110% -> Amarillo
          } else if (percentage < 125) {
            colorClass = "text-orange-600"; // 110-125% -> Naranja
          } else {
            // 125% o m√°s
            colorClass = "text-red-600"; // 125+ -> Rojo
          }
          return baseClass + " " + colorClass;
        }

        // Actualiza el gran display central, la instrucci√≥n peque√±a y la barra de progreso principal
        updateMainWeightDisplay(
          addedGrams,
          ingredientName,
          requiredGrams,
          percentage
        ) {
          const addedDisplay = document.getElementById("added-weight-display");
          const targetDisplay = document.getElementById(
            "target-weight-display"
          );
          const progressBarContainer = document.getElementById(
            "main-progress-bar-container"
          );
          const progressBar = document.getElementById("main-progress-bar");
          const percentText = document.getElementById("main-progress-percent");

          // Actualizar Display de Peso
          addedDisplay.textContent = addedGrams.toFixed(2);

          // 1. Mostrar/Ocultar barra de progreso
          if (
            ingredientName === "Pesare Contenitore" ||
            ingredientName === null
          ) {
            progressBarContainer.style.display = "none";
            addedDisplay.className =
              "weight-main-display text-gray-800 transition-colors duration-300";
          } else {
            // Modo Ingrediente
            progressBarContainer.style.display = "block";

            const barColorClass = this.getProgressBarColorClass(percentage);
            const textColorClass = this.getWeightTextColorClass(percentage);

            // Aplicar clases de color
            addedDisplay.className = textColorClass;
            progressBar.className = `w-full ${barColorClass}`;
            percentText.className = `text-sm font-medium text-center mt-1 ${barColorClass.replace(
              "bar-",
              "progress-"
            )}`;

            // La barra de progreso solo puede ir de 0 a 100, as√≠ que la limitamos visualmente
            progressBar.value = Math.min(100, Math.max(0, percentage));
            percentText.textContent = `${percentage.toFixed(0)}% Versato`;
          }

          // 2. Actualizar texto de objetivo
          if (ingredientName === "Pesare Contenitore") {
            targetDisplay.innerHTML =
              '<span class="text-gray-800">Pesare Contenitore</span>';
          } else if (ingredientName !== null && requiredGrams !== null) {
            // Modo Ingrediente
            targetDisplay.innerHTML = `<span class="text-lg font-bold text-gray-800">${ingredientName}</span>
                                               <span class="text-sm font-semibold text-gray-500">| ${requiredGrams.toFixed(
                                                 2
                                               )}g Richiesti</span>`;
          } else {
            // Estado inicial o finalizado/inactivo
            targetDisplay.innerHTML =
              "Peso Neto (B√°scula Bruta - Tara Anterior)";
            percentText.textContent = "0% Versato";
          }
        }

        // Renderiza la tabla de ingredientes de la receta
        renderRecipe(recipe, name) {
          document.getElementById(
            "prep-title"
          ).textContent = `Ricetta: ${name}`;
          this.setNextButtonVisibility(true);

          const tbody = document.getElementById("recipe-table-body");
          tbody.innerHTML = "";

          recipe.forEach((item, index) => {
            const row = tbody.insertRow();
            row.id = `ingredient-row-${index}`;
            row.className = "hover:bg-gray-50 transition duration-150"; // Tailwind class
            row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${
                          item.name
                        }</td>
                        <td id="required-${index}" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${item.grams.toFixed(
              2
            )}g</td>
                        <td id="added-${index}" class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 font-semibold">0.00g</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <progress id="progress-${index}" value="0" max="100" class="w-full bar-color-black"></progress>
                        </td>
                        <td id="percent-${index}" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 progress-color-black">0%</td>
                    `;
            row.addEventListener("click", () => {
              recipePrepController.setStep(index);
            });
          });

          this.updateCurrentIngredient(-1); // Inicializa a -1 (modo TARA)
        }

        // Muestra la instrucci√≥n actual
        showInstructions(message) {
          document.getElementById("current-instruction").innerHTML = message;
        }

        // Actualiza la visualizaci√≥n de los pesos de referencia
        updateStatus(rawWeightKg, tareWeight) {
          document.getElementById("raw-weight").textContent =
            rawWeightKg.toFixed(2) + "g";
          document.getElementById("tare-weight").textContent =
            tareWeight.toFixed(2) + "g";
        }

        // Resalta la fila del ingrediente actual
        updateCurrentIngredient(index) {
          // Limpiar resaltado anterior
          document.querySelectorAll("#recipe-table-body tr").forEach((row) => {
            row.classList.remove("current-ingredient-row");
          });

          // Aplicar resaltado al ingrediente actual
          if (index >= 0) {
            const currentRow = document.getElementById(
              `ingredient-row-${index}`
            );
            if (currentRow) {
              currentRow.classList.add("current-ingredient-row");
            }
          }
        }

        // Marca una fila como permanentemente completada
        markRowAsCompleted(index) {
          const row = document.getElementById(`ingredient-row-${index}`);
          if (row) {
            row.classList.remove("current-ingredient-row");
            row.classList.add("completed-ingredient-row");
          }
        }

        // Actualiza la fila de la tabla para el ingrediente que se est√° pesando
        updateTableProgress(index, addedGrams, requiredGrams, percentage) {
          const row = document.getElementById(`ingredient-row-${index}`);
          if (row) {
            const barColorClass = this.getProgressBarColorClass(percentage);

            const addedCell = document.getElementById(`added-${index}`);
            const progressElement = document.getElementById(
              `progress-${index}`
            );
            const percentElement = document.getElementById(`percent-${index}`);

            addedCell.textContent = addedGrams.toFixed(2) + "g";

            // La barra de progreso solo va de 0 a 100
            progressElement.value = Math.min(100, Math.max(0, percentage));
            progressElement.className = `w-full ${barColorClass}`;

            percentElement.textContent = percentage.toFixed(0) + "%";
            percentElement.className = `px-4 py-3 whitespace-nowrap text-sm ${barColorClass.replace(
              "bar-",
              "progress-"
            )}`;
          }
        }

        // Muestra/oculta el bot√≥n de Siguiente Ingrediente
        setNextButtonVisibility(isVisible) {
          document.getElementById("next-ingredient-btn").style.display =
            isVisible ? "block" : "none";
        }

        // Muestra/oculta el bot√≥n de recalcular cantidades (visible solo en overflow)
        setRecalcButtonVisibility(isVisible) {
          document.getElementById("recalc-btn").style.display = isVisible
            ? "block"
            : "none";
        }

        // Actualiza solo el valor requerido (segunda columna) para un ingrediente dado
        updateIngredientRequiredGram(index, newGrams) {
          const cell = document.getElementById(`required-${index}`);
          if (cell) {
            cell.textContent = `${newGrams.toFixed(2)}g`;
          }
        }

        // Habilita/deshabilita el bot√≥n Poner a Cero
        setZeroButtonEnabled(isEnabled) {
          document.getElementById("zero-btn").disabled = !isEnabled;
          const button = document.getElementById("zero-btn");
          if (isEnabled) {
            button.classList.remove("opacity-50", "cursor-not-allowed");
            button.classList.add("bg-gray-500", "hover:bg-gray-600");
          } else {
            button.classList.add("opacity-50", "cursor-not-allowed");
            button.classList.remove("bg-gray-500", "hover:bg-gray-600");
          }
        }

        // Cambia el texto del bot√≥n Siguiente/Finalizar/Tara
        setNextButtonText(isFinalIngredient, isTare = false) {
          const button = document.getElementById("next-ingredient-btn");
          if (isTare) {
            button.textContent = "Tarare";
            // Ensure it looks like the normal next button
            button.classList.remove("bg-orange-500", "hover:bg-orange-600");
            button.classList.add("bg-green-600", "hover:bg-green-700");
          } else {
            button.textContent = isFinalIngredient
              ? "Completa Ricetta"
              : "Ingrediente Successivo";

            // Highlight finalize button
            if (isFinalIngredient) {
              button.classList.remove("bg-green-600", "hover:bg-green-700");
              button.classList.add("bg-orange-500", "hover:bg-orange-600");
            } else {
              button.classList.remove("bg-orange-500", "hover:bg-orange-600");
              button.classList.add("bg-green-600", "hover:bg-green-700");
            }
          }
        }

        // Funci√≥n para resetear el estado de la UI al finalizar
        resetUI() {
          console.log("reset");

          document.getElementById(
            "prep-title"
          ).textContent = `Dettaglio della Ricetta`;
          this.setNextButtonVisibility(false);
          document.getElementById("main-progress-bar-container").style.display =
            "none";
          document.getElementById("recipe-table-body").innerHTML = ""; // Clear table

          // Reset reference weights
          document.getElementById("raw-weight").textContent = "0.00 g";
          document.getElementById("tare-weight").textContent = "0.00 g";

          // Importante: Reiniciar el display principal a 0.00 y el mensaje inicial
          this.updateMainWeightDisplay(0.0, null, null, 0);
          this.showInstructions(
            "üëã Seleziona una ricetta per iniziare la preparazione."
          );
        }
      }

      // =================================================================
      // 5. L√ìGICA DE INICIALIZACI√ìN Y TECLADO (MAIN)
      // =================================================================

      const scalePublisher = new WeightPublisher();
      const recipeManager = new RecipeManager();
      const recipePrepController = new RecipePrepController(recipeManager);

      // Suscribir el controlador de preparaci√≥n al publicador de la b√°scula
      scalePublisher.subscribe(recipePrepController);

      // --- L√≥gica de Captura de Teclado (Simulaci√≥n de la B√°scula en Kg) ---
      let buffer = "";
      // El patr√≥n acepta 0 o m√°s d√≠gitos, seguido de una coma, seguido de uno o m√°s d√≠gitos
      const SCALE_PATTERN = /^(\d*|0),\d+$/;

      document.addEventListener("keydown", (event) => {
        // Prevenimos que la tecla Enter haga algo m√°s (como enviar un formulario)
        console.log(event.key);

        if (event.key === "Enter") {
          const finalReading = buffer.trim();
          buffer = "";
          console.log(buffer);

          if (finalReading && SCALE_PATTERN.test(finalReading)) {
            // El publicador notifica a todos los suscriptores. La conversi√≥n a gramos se hace dentro.
            scalePublisher.setWeight(finalReading);
          } else {
            console.warn(
              `[Scale Input] Lettura bilancia non valida o vuota: "${finalReading}". Il formato atteso √® "X,XX" (in Kg).`
            );
          }

          event.preventDefault();
        } else if (
          event.key.length === 1 &&
          !event.ctrlKey &&
          !event.altKey &&
          !event.metaKey
        ) {
          // Captura caracteres individuales que vienen de la b√°scula
          buffer += event.key;
        }
      });
      document.addEventListener("keyup", (event) => {
        console.log(event.key);
      });

      // --- L√≥gica de Interfaz y Carga Inicial ---
      document.addEventListener("DOMContentLoaded", () => {
        // Llenar el selector de recetas
        const selector = document.getElementById("recipe-selector");
        recipeManager.getRecipeNames().forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          selector.appendChild(option);
        });

        // Asignar eventos de botones
        document
          .getElementById("start-prep-btn")
          .addEventListener("click", () => {
            const selectedRecipe = selector.value;
            if (selectedRecipe) {
              recipePrepController.startPreparation(selectedRecipe);
            } else {
              // Feedback visual en lugar de alert
              document.getElementById(
                "current-instruction"
              ).innerHTML = `<span class="text-red-600">‚ö†Ô∏è Per favore, seleziona una ricetta valida per iniziare.</span>`;
            }
          });

        document
          .getElementById("next-ingredient-btn")
          .addEventListener("click", () => {
            recipePrepController.nextStep();
          });

        document.getElementById("zero-btn").addEventListener("click", () => {
          // Simula que la b√°scula lee "0,00" Kg
          scalePublisher.setWeight("0,00");
          // La UI se actualizar√° a trav√©s del ciclo Observer/Publisher
        });

        // Recalcular cantidades en caso de overflow
        document.getElementById("recalc-btn").addEventListener("click", () => {
          recipePrepController.recalculateKeepProportions();
        });

        // Inicializar bot√≥n de Siguiente Ingrediente oculto
        recipePrepController.displayManager.setNextButtonVisibility(false);
        recipePrepController.displayManager.setZeroButtonEnabled(true);
        // Asegurar que el bot√≥n de recalcular est√© oculto al inicio
        recipePrepController.displayManager.setRecalcButtonVisibility(false);
      });
    </script>
  </body>
</html>
